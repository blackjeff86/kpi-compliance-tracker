{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/jeff.brito/Documents/KPI%20Compliance%20Tracker/projeto/lib/db.ts"],"sourcesContent":["import { neon } from \"@neondatabase/serverless\"\n\nconst DATABASE_URL = process.env.DATABASE_URL\nif (!DATABASE_URL) throw new Error(\"DATABASE_URL nÃ£o configurada.\")\n\nexport const sql = neon(DATABASE_URL)\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY;AAC7C,IAAI,CAAC,cAAc,MAAM,IAAI,MAAM;AAE5B,MAAM,MAAM,IAAA,yOAAI,EAAC"}},
    {"offset": {"line": 59, "column": 0}, "map": {"version":3,"sources":["file:///Users/jeff.brito/Documents/KPI%20Compliance%20Tracker/projeto/app/api/controls/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { sql } from \"@/lib/db\"\n\nexport const dynamic = \"force-dynamic\"\n\ntype Status = \"GREEN\" | \"YELLOW\" | \"RED\"\ntype Risk = \"LOW\" | \"MED\" | \"HIGH\" | \"CRITICAL\"\ntype Frequency = \"MONTHLY\" | \"QUARTERLY\" | \"SEMIANNUAL\" | \"ANNUAL\" | \"CONTINUOUS\"\ntype Framework = \"SOX\" | \"SOC\" | \"ISO\" | \"PCI\"\n\ntype Row = {\n  id: string\n  framework_code: string\n  control_code: string\n  name: string\n  description: string | null\n  frequency: string\n  risk_level: string\n  owner_email: string\n  focal_email: string\n  total_kpis: number\n  green_kpis: number\n  yellow_kpis: number\n  red_kpis: number\n  last_exec_at: string | null\n}\n\nfunction normalizeFramework(code: string): Framework {\n  const v = (code || \"\").toUpperCase()\n  if (v === \"SOX\" || v === \"SOC\" || v === \"ISO\" || v === \"PCI\") return v\n  return \"SOX\"\n}\n\nfunction normalizeRisk(riskLevel: string): Risk {\n  const v = (riskLevel || \"\").toUpperCase()\n  if (v === \"LOW\") return \"LOW\"\n  if (v === \"MED\" || v === \"MEDIUM\") return \"MED\"\n  if (v === \"HIGH\") return \"HIGH\"\n  if (v === \"CRITICAL\") return \"CRITICAL\"\n  return \"MED\"\n}\n\nfunction normalizeFrequency(freq: string): Frequency {\n  const v = (freq || \"\").toUpperCase()\n  if (v === \"MONTHLY\") return \"MONTHLY\"\n  if (v === \"QUARTERLY\") return \"QUARTERLY\"\n  if (v === \"SEMIANNUAL\") return \"SEMIANNUAL\"\n  if (v === \"ANNUAL\") return \"ANNUAL\"\n  return \"CONTINUOUS\"\n}\n\nfunction addByFrequency(iso: string | null, freq: Frequency): string | undefined {\n  if (!iso) return undefined\n  const d = new Date(iso)\n  if (Number.isNaN(d.getTime())) return undefined\n\n  const n = new Date(d)\n  if (freq === \"MONTHLY\") n.setMonth(n.getMonth() + 1)\n  else if (freq === \"QUARTERLY\") n.setMonth(n.getMonth() + 3)\n  else if (freq === \"SEMIANNUAL\") n.setMonth(n.getMonth() + 6)\n  else if (freq === \"ANNUAL\") n.setFullYear(n.getFullYear() + 1)\n  else n.setMonth(n.getMonth() + 1)\n\n  return n.toISOString().slice(0, 10)\n}\n\nexport async function GET() {\n  const rows = (await sql`\n    select\n      c.id,\n      f.code as framework_code,\n      c.control_code,\n      c.name,\n      c.description,\n      c.frequency::text as frequency,\n      c.risk_level,\n      c.owner_email,\n      c.focal_email,\n\n      count(distinct k.id)::int as total_kpis,\n\n      coalesce(sum(case when r.status::text = 'GREEN' then 1 else 0 end),0)::int as green_kpis,\n      coalesce(sum(case when r.status::text = 'YELLOW' then 1 else 0 end),0)::int as yellow_kpis,\n      coalesce(sum(case when r.status::text = 'RED' then 1 else 0 end),0)::int as red_kpis,\n\n      max(r.created_at)::text as last_exec_at\n\n    from controls c\n    join frameworks f on f.id = c.framework_id\n    left join kpis k on k.control_id = c.id and k.is_active = true\n    left join kpi_runs r on r.kpi_id = k.id and r.is_latest = true\n    where c.is_active = true\n    group by c.id, f.code, c.control_code, c.name, c.description, c.frequency, c.risk_level, c.owner_email, c.focal_email\n    order by f.code, c.control_code;\n  `) as unknown as Row[]\n\n  const data = rows.map((row) => {\n    const framework = normalizeFramework(row.framework_code)\n    const risk = normalizeRisk(row.risk_level)\n    const frequency = normalizeFrequency(row.frequency)\n\n    const red = row.red_kpis ?? 0\n    const yellow = row.yellow_kpis ?? 0\n    const green = row.green_kpis ?? 0\n    const total = row.total_kpis ?? 0\n\n    const status: Status = red > 0 ? \"RED\" : yellow > 0 ? \"YELLOW\" : \"GREEN\"\n\n    const lastExecutionAt = row.last_exec_at ? row.last_exec_at.slice(0, 10) : undefined\n    const nextExecutionAt = addByFrequency(row.last_exec_at, frequency)\n\n    return {\n      id: row.control_code,\n      code: row.control_code,\n      name: row.name,\n      framework,\n      ownerName: row.owner_email,\n      focalName: row.focal_email,\n      frequency,\n      risk,\n      description: row.description ?? \"\",\n      lastExecutionAt,\n      nextExecutionAt,\n      kpis: { total, green, yellow, red },\n      status,\n    }\n  })\n\n  return NextResponse.json(data)\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,MAAM,UAAU;AAwBvB,SAAS,mBAAmB,IAAY;IACtC,MAAM,IAAI,CAAC,QAAQ,EAAE,EAAE,WAAW;IAClC,IAAI,MAAM,SAAS,MAAM,SAAS,MAAM,SAAS,MAAM,OAAO,OAAO;IACrE,OAAO;AACT;AAEA,SAAS,cAAc,SAAiB;IACtC,MAAM,IAAI,CAAC,aAAa,EAAE,EAAE,WAAW;IACvC,IAAI,MAAM,OAAO,OAAO;IACxB,IAAI,MAAM,SAAS,MAAM,UAAU,OAAO;IAC1C,IAAI,MAAM,QAAQ,OAAO;IACzB,IAAI,MAAM,YAAY,OAAO;IAC7B,OAAO;AACT;AAEA,SAAS,mBAAmB,IAAY;IACtC,MAAM,IAAI,CAAC,QAAQ,EAAE,EAAE,WAAW;IAClC,IAAI,MAAM,WAAW,OAAO;IAC5B,IAAI,MAAM,aAAa,OAAO;IAC9B,IAAI,MAAM,cAAc,OAAO;IAC/B,IAAI,MAAM,UAAU,OAAO;IAC3B,OAAO;AACT;AAEA,SAAS,eAAe,GAAkB,EAAE,IAAe;IACzD,IAAI,CAAC,KAAK,OAAO;IACjB,MAAM,IAAI,IAAI,KAAK;IACnB,IAAI,OAAO,KAAK,CAAC,EAAE,OAAO,KAAK,OAAO;IAEtC,MAAM,IAAI,IAAI,KAAK;IACnB,IAAI,SAAS,WAAW,EAAE,QAAQ,CAAC,EAAE,QAAQ,KAAK;SAC7C,IAAI,SAAS,aAAa,EAAE,QAAQ,CAAC,EAAE,QAAQ,KAAK;SACpD,IAAI,SAAS,cAAc,EAAE,QAAQ,CAAC,EAAE,QAAQ,KAAK;SACrD,IAAI,SAAS,UAAU,EAAE,WAAW,CAAC,EAAE,WAAW,KAAK;SACvD,EAAE,QAAQ,CAAC,EAAE,QAAQ,KAAK;IAE/B,OAAO,EAAE,WAAW,GAAG,KAAK,CAAC,GAAG;AAClC;AAEO,eAAe;IACpB,MAAM,OAAQ,MAAM,kHAAG,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;EA2BxB,CAAC;IAED,MAAM,OAAO,KAAK,GAAG,CAAC,CAAC;QACrB,MAAM,YAAY,mBAAmB,IAAI,cAAc;QACvD,MAAM,OAAO,cAAc,IAAI,UAAU;QACzC,MAAM,YAAY,mBAAmB,IAAI,SAAS;QAElD,MAAM,MAAM,IAAI,QAAQ,IAAI;QAC5B,MAAM,SAAS,IAAI,WAAW,IAAI;QAClC,MAAM,QAAQ,IAAI,UAAU,IAAI;QAChC,MAAM,QAAQ,IAAI,UAAU,IAAI;QAEhC,MAAM,SAAiB,MAAM,IAAI,QAAQ,SAAS,IAAI,WAAW;QAEjE,MAAM,kBAAkB,IAAI,YAAY,GAAG,IAAI,YAAY,CAAC,KAAK,CAAC,GAAG,MAAM;QAC3E,MAAM,kBAAkB,eAAe,IAAI,YAAY,EAAE;QAEzD,OAAO;YACL,IAAI,IAAI,YAAY;YACpB,MAAM,IAAI,YAAY;YACtB,MAAM,IAAI,IAAI;YACd;YACA,WAAW,IAAI,WAAW;YAC1B,WAAW,IAAI,WAAW;YAC1B;YACA;YACA,aAAa,IAAI,WAAW,IAAI;YAChC;YACA;YACA,MAAM;gBAAE;gBAAO;gBAAO;gBAAQ;YAAI;YAClC;QACF;IACF;IAEA,OAAO,+QAAY,CAAC,IAAI,CAAC;AAC3B"}}]
}